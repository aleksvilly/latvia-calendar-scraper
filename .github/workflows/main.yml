name: Scrape calendar dates (compressed history)

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch and compress history
        run: |
          mkdir -p data

          process_url() {
            URL=$1
            FILE=$2
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            RAW=$(curl -s \
              -H "Accept: application/json" \
              -H "User-Agent: Mozilla/5.0" \
              "$URL")

            if echo "$RAW" | jq . >/dev/null 2>&1; then
              VALUE=$(echo "$RAW" | jq -c '[.availableDates[]?.date]')
            else
              VALUE="[]"
            fi

            # init file
            if [ ! -f "data/$FILE" ]; then
              echo "[]" > data/$FILE
            fi

            LAST_VALUE=$(jq -c '.[-1].value // empty' data/$FILE)

            if [ "$VALUE" = "[]" ] && [ "$LAST_VALUE" = "[]" ]; then
              # merge empty blocks
              jq --arg now "$NOW" '
                .[-1].last_scrap = $now
                | .[-1].count += 1
              ' data/$FILE > data/tmp.json
            else
              # append new block
              jq --arg now "$NOW" --argjson value "$VALUE" '
                . += [{
                  start_scrap: $now,
                  last_scrap: $now,
                  count: 1,
                  value: $value
                }]
              ' data/$FILE > data/tmp.json
            fi

            mv data/tmp.json data/$FILE
          }

          process_url \
            "https://pieraksts.mfa.gov.lv/en/calendar/available-month-dates?year=2026&month=2" \
            "dates-2026-02-history.json"

          process_url \
            "https://pieraksts.mfa.gov.lv/en/calendar/available-month-dates?year=2026&month=3" \
            "dates-2026-03-history.json"

      - name: Commit compressed history
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data
          git commit -m "Update compressed calendar history" || echo "No changes"
          git push
