# .github/workflows/check-latvian-appointments.yml

name: Check Egypt ‚Üí Latvia appointment slots

on:
  schedule:
    - cron: '17 */3 * * *'          # every 3 hours at :17
  workflow_dispatch:                # allow manual trigger

jobs:
  check-appointments:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright/python:v1.49.0-noble  # ‚Üê or :latest / :v1.50.0-noble etc.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Write script & secrets to file
        env:
          TELEGRAM_TOKEN:     ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat > check.py << 'EOF'
          import traceback
          import requests
          from playwright.sync_api import sync_playwright
          import os

          TELEGRAM_TOKEN    = os.getenv("TELEGRAM_TOKEN")
          TELEGRAM_CHAT_ID  = os.getenv("TELEGRAM_CHAT_ID")

          def notify_telegram(message: str):
              if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
                  print("Missing Telegram token/chat_id ‚Üí", message)
                  return
              url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
              try:
                  requests.post(url, data={"chat_id": TELEGRAM_CHAT_ID, "text": message}, timeout=10)
              except Exception as e:
                  print("Telegram notify failed:", e)

          def run(playwright):
              try:
                  browser = playwright.chromium.launch(headless=True)
                  context = browser.new_context(viewport={"width": 762, "height": 695})
                  page = context.new_page()

                  page.goto("https://pieraksts.mfa.gov.lv/en/egypt/index", wait_until="networkidle")

                  page.fill('#Persons\\[0\\]\\[first_name\\]', 'xxemple')
                  page.fill('#Persons\\[0\\]\\[last_name\\]', 'rd2000')
                  page.fill('#e_mail', 'example@gmail.com')
                  page.fill('#e_mail_repeat', 'example@gmail.com')
                  page.fill('#phone', '+212666666666')

                  page.click('#step1-next-btn > button')
                  page.wait_for_url("**/step2", timeout=25000)

                  page.click("div.form-services--title")
                  page.click("div.services--wrapper > div:nth-of-type(1) > span")
                  page.click("section.active span")
                  page.click("section.active > div.description-text--wrapper button")

                  page.click("#step2-next-btn > button")

                  # ‚îÄ‚îÄ Check availability ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                  available_response = page.evaluate("""async () => {
                      const res = await fetch('https://pieraksts.mfa.gov.lv/en/calendar/available-month-dates?year=2025&month=6', {
                          method: 'GET',
                          credentials: 'same-origin'
                      });
                      return await res.text();
                  }""")

                  notify_telegram("üìÖ Response from available-month-dates:\\n" + available_response)

                  last_date = page.evaluate("""async () => {
                      const res = await fetch('https://pieraksts.mfa.gov.lv/en/calendar/last-available-date', {
                          method: 'GET',
                          credentials: 'same-origin'
                      });
                      return await res.text();
                  }""")

                  notify_telegram("üïì Last available date:\\n" + last_date)

                  if "Currently all dates are fully booked" in available_response:
                      notify_telegram("‚ùå Aucun cr√©neau disponible pour juin 2025.")
                  else:
                      notify_telegram("‚úÖ Des cr√©neaux peuvent √™tre disponibles !\\nV√©rifiez manuellement.")

              except Exception as e:
                  error_message = f"‚ùå Playwright error:\\n{str(e)}\\n\\n{traceback.format_exc()}"
                  notify_telegram(error_message)
                  raise  # let GH show failed status

          if __name__ == "__main__":
              with sync_playwright() as p:
                  run(p)
          EOF

      - name: Run appointment checker
        run: python check.py
